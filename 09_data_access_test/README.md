# 데이터 접근기술 - 테스트 

## @SpringBootTest
```java
@SpringBootTest
class ItemRepositoryTest {}
```
- ItemRepositoryTest 는 @SpringBootTest 를 사용한다.
- @SpringBootTest 는 @SpringBootApplication 를 찾아서 설정으로 사용한다.

## 테스트에서 매우 중요한 원칙은 다음과 같다.
1. 테스트는 다른 테스트와 격리해야 한다.
2. 테스트는 반복해서 실행할 수 있어야 한다.

## 데이터 롤백
- 테스트를 실행하고 바로 롤백을 해버리면 된다.
- @BeforeEach, @AfterEach 를 활용하자.
1. TransactionManager를 활용하여 commit 없이 rollback만 활용하자.
2. @Transactional 을 사용하자.
> @Transactional 애노테이션을 테스트에서 사용하면, 테스트가 끝났을 때 트랜잭션을 자동으로 롤백시켜 버린다! (물론, @Commit 혹은 @Rollback(value = false) 을 붙이면 강제 커밋도 가능하다.)

## 임베디드 모드 DB
- DB를 애플리케이션에 내장해서 함께 실행하는 모드.
- 애플리케이션이 종료되면 임베디드 모드로 동작하는 H2 데이터베이스도 함께 종료되고, 데이터도 모두 사라진다.
#### @Profile("test")
- 프로필이 test 인 경우에만 데이터소스를 스프링 빈으로 등록한다.
#### dataSource()
- jdbc:h2:mem:db : 이 부분이 중요하다. 데이터소스를 만들때 이렇게만 적으면 임베디드 모드(메모리 모드)로 동작하는 H2 데이터베이스를 사용할 수 있다.
- DB_CLOSE_DELAY=-1 : 임베디드 모드에서는 데이터베이스 커넥션 연결이 모두 끊어지면 데이터베이스도 종료되는데, 그것을 방지하는 설정이다.
```java
@Bean
@Profile("test")
public DataSource dataSource() {
  log.info("메모리 데이터베이스 초기화");
  DriverManagerDataSource dataSource = new DriverManagerDataSource();
  dataSource.setDriverClassName("org.h2.Driver");
  dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
  dataSource.setUsername("sa");
  dataSource.setPassword("");
  return dataSource;
}
```
- 다만, test/resources/schema.sql 에 인메모리DB를 위한 임의의 sql을 생성할 수 있도록 해야 한다.
- 파일 명도 schema.sql 로 완벽하게 동일해야 한다. 예를들어 다음과 같다.
```sql
# src/test/resources/schema.sql
```sql
drop table if exists item CASCADE;
create table item
(
 id bigint generated by default as identity,
 item_name varchar(10),
 price integer,
 quantity integer,
 primary key (id)
);
```

## 하지만, test 폴더에서 설정 정보를 모두 지운다면?
- 지우면 자동으로 Embedded mode 로 설정되어서 실행된다.
- 예를들어, *conn0: url=jdbc:h2:mem:d8fb3a29-caf7-4b37-9b6c-b0eed9985454* 이런식으로 임의의 embeddeddatasource를 생성한다.

## 결론
- @Transactional 을 넣고
- application.properties 등에 따로 설정해줄 필요도 없다.
